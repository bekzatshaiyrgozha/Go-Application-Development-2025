# Практическое задание: Docker для Final-проекта

## Цель задания

Настроить Docker-окружение для вашего Golang-приложения с правильной конфигурацией и ограничением ресурсов. Это задание поможет вам подготовить Docker-инфраструктуру для финального проекта.

## Предварительные требования

- Установленный Docker и Docker Compose
- Базовый Golang-проект (можно использовать свой финальный проект или шаблон из прошлых лекций)

### Часть 1: Создание оптимизированного Dockerfile

1. Создайте файл `Dockerfile` в корневой директории вашего проекта.
2. Реализуйте многоступенчатую сборку (multi-stage build):
   - Используйте `golang:1.24-alpine` для стадии сборки
   - Используйте `scratch` или `alpine` для финального образа
   - Настройте правильные рабочие директории и переменные окружения
   - Оптимизируйте кэширование зависимостей (разделите копирование `go.mod`/`go.sum` и остального кода)

3. Соберите образ и проверьте его размер:
   ```bash
   docker build -t myapp:latest .
   docker images myapp:latest
   ```

### Часть 2: Настройка Docker Compose

1. Создайте файл `docker-compose.yml` в корневой директории.
2. Определите как минимум два сервиса:
   - Ваше Golang-приложение 
   - База данных (PostgreSQL, MySQL или MongoDB - на ваш выбор)

3. Настройте:
   - Переменные окружения для подключения к БД
   - Порты для доступа к приложению
   - Постоянные тома (volumes) для данных БД
   - Зависимости между сервисами (depends_on)

4. Запустите контейнеры и проверьте, что они корректно работают:
   ```bash
   docker-compose up -d
   docker-compose ps
   ```

### Часть 3: Ограничение ресурсов в compose

1. Добавьте в `docker-compose.yml` ограничения ресурсов для вашего приложения:
   ```yaml
   services:
     app:
       # ...существующая конфигурация...
       deploy:
         resources:
           limits:
             # здесь ставить ограничения
   ```

2. Перезапустите контейнеры и убедитесь, что ограничения применены:
   ```bash
   docker-compose up -d --force-recreate
   docker stats
   ```

## Бонусные задания

### Опция 1: Оптимизация для Golang

Модифицируйте ваш код Golang для корректной работы с ограниченными ресурсами:

1. Добавьте автоматическую настройку `GOMAXPROCS` в зависимости от ограничений:
2. Запустите приложение и убедитесь, что `GOMAXPROCS` установлен корректно, добавив отладочный вывод:
   ```go
   fmt.Printf("GOMAXPROCS: %d\n", runtime.GOMAXPROCS(0))
   ```

### Опция 2: Создание .dockerignore

1. Создайте файл `.dockerignore` и добавьте в него:
   ```
   .git/
   .idea/
   .vscode/
   README.md
   *.log
   tmp/
   ```

2. Пересоберите образ и проверьте, изменился ли его размер.

### Опция 3: Настройка health check

Добавьте проверку работоспособности (health check) для вашего приложения в `docker-compose.yml`:

## Критерии успешного выполнения

1. ✅ Dockerfile использует многоступенчатую сборку и оптимизирован по размеру
2. ✅ Docker Compose настроен и запускает ваше приложение с базой данных
3. ✅ Применены ограничения ресурсов через в compose
4. ✅ Контейнеры успешно запускаются и коммуницируют между собой

## Подсказки

- Уделите внимание корректной настройке сетевого взаимодействия между контейнерами
- Для отладки используйте `docker logs <container_id>` и `docker exec -it <container_id> sh`
- Для PostgreSQL в Docker Compose можно задать начальные скрипты, поместив их в `/docker-entrypoint-initdb.d/`
- При использовании `scratch` образа не забудьте копировать SSL-сертификаты, если ваше приложение делает HTTPS запросы